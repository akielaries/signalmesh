#pragma once

#include <stdint.h>
#include <stdbool.h>
#include "drivers/driver_api.h"
#include "drivers/i2c.h"

#ifdef __cplusplus
extern "C" {
#endif

// INA3221 I2C address, assuming A0 is connected to VS. Default is 0x40.
#define INA3221_DEFAULT_ADDRESS 0x41

// INA3221 register addresses
#define INA3221_REG_CONFIG 0x00
#define INA3221_REG_CH1_SHUNTVOLTAGE 0x01
#define INA3221_REG_CH1_BUSVOLTAGE 0x02
#define INA3221_REG_CH2_SHUNTVOLTAGE 0x03
#define INA3221_REG_CH2_BUSVOLTAGE 0x04
#define INA3221_REG_CH3_SHUNTVOLTAGE 0x05
#define INA3221_REG_CH3_BUSVOLTAGE 0x06
#define INA3221_REG_CH1_CRITICAL_ALERT 0x07
#define INA3221_REG_CH1_WARNING_ALERT 0x08
#define INA3221_REG_CH2_CRITICAL_ALERT 0x09
#define INA3221_REG_CH2_WARNING_ALERT 0x0A
#define INA3221_REG_CH3_CRITICAL_ALERT 0x0B
#define INA3221_REG_CH3_WARNING_ALERT 0x0C
#define INA3221_REG_SHUNT_SUM 0x0D
#define INA3221_REG_SHUNT_SUM_LIMIT 0x0E
#define INA3221_REG_MASK_ENABLE 0x0F
#define INA3221_REG_POWER_VALID_UPPER_LIMIT 0x10
#define INA3221_REG_POWER_VALID_LOWER_LIMIT 0x11
#define INA3221_REG_MANUFACTURER_ID 0xFE
#define INA3221_REG_DIE_ID 0xFF

// Config register masks
#define INA3221_CONFIG_RESET_MASK (1 << 15)
#define INA3221_CONFIG_CH3_EN_MASK (1 << 14)
#define INA3221_CONFIG_CH2_EN_MASK (1 << 13)
#define INA3221_CONFIG_CH1_EN_MASK (1 << 12)
#define INA3221_CONFIG_AVG_MASK (7 << 9)
#define INA3221_CONFIG_VBUS_CT_MASK (7 << 6)
#define INA3221_CONFIG_VSH_CT_MASK (7 << 3)
#define INA3221_CONFIG_MODE_MASK 7

// Config register values
#define INA3221_CONFIG_RESET (1 << 15)
#define INA3221_CONFIG_CH3_EN (1 << 14)
#define INA3221_CONFIG_CH2_EN (1 << 13)
#define INA3221_CONFIG_CH1_EN (1 << 12)

#define INA3221_CONFIG_AVG_1 (0 << 9)
#define INA3221_CONFIG_AVG_4 (1 << 9)
#define INA3221_CONFIG_AVG_16 (2 << 9)
#define INA3221_CONFIG_AVG_64 (3 << 9)
#define INA3221_CONFIG_AVG_128 (4 << 9)
#define INA3221_CONFIG_AVG_256 (5 << 9)
#define INA3221_CONFIG_AVG_512 (6 << 9)
#define INA3221_CONFIG_AVG_1024 (7 << 9)

#define INA3221_CONFIG_VBUS_CT_140US (0 << 6)
#define INA3221_CONFIG_VBUS_CT_204US (1 << 6)
#define INA3221_CONFIG_VBUS_CT_332US (2 << 6)
#define INA3221_CONFIG_VBUS_CT_588US (3 << 6)
#define INA3221_CONFIG_VBUS_CT_1100US (4 << 6)
#define INA3221_CONFIG_VBUS_CT_2116US (5 << 6)
#define INA3221_CONFIG_VBUS_CT_4156US (6 << 6)
#define INA3221_CONFIG_VBUS_CT_8244US (7 << 6)

#define INA3221_CONFIG_VSH_CT_140US (0 << 3)
#define INA3221_CONFIG_VSH_CT_204US (1 << 3)
#define INA3221_CONFIG_VSH_CT_332US (2 << 3)
#define INA3221_CONFIG_VSH_CT_588US (3 << 3)
#define INA3221_CONFIG_VSH_CT_1100US (4 << 3)
#define INA3221_CONFIG_VSH_CT_2116US (5 << 3)
#define INA3221_CONFIG_VSH_CT_4156US (6 << 3)
#define INA3221_CONFIG_VSH_CT_8244US (7 << 3)

#define INA3221_CONFIG_MODE_POWERDOWN 0
#define INA3221_CONFIG_MODE_SHUNT_ONCE 1
#define INA3221_CONFIG_MODE_BUS_ONCE 2
#define INA3221_CONFIG_MODE_SHUNT_BUS_ONCE 3
#define INA3221_CONFIG_MODE_POWERDOWN2 4
#define INA3221_CONFIG_MODE_SHUNT_CONTINUOUS 5
#define INA3221_CONFIG_MODE_BUS_CONTINUOUS 6
#define INA3221_CONFIG_MODE_SHUNT_BUS_CONTINUOUS 7

#define INA3221_SHUNT_VOLTAGE_LSB 0.04f // 40uV
#define INA3221_BUS_VOLTAGE_LSB 0.008f   // 8mV

// INA3221 device private data structure
typedef struct {
  i2c_bus_t bus;
  float shunt_resistors[3];
} ina3221_t;

extern const driver_t ina3221_driver;

#ifdef __cplusplus
}
#endif